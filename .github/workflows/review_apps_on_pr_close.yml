name: "Review apps: on PR close"
on:
  pull_request:
    # only run when a PR is closed or merged
    types: [closed]
env:
  IMAGE_TAG: "842676007477.dkr.ecr.eu-west-2.amazonaws.com/forms-admin:pr-${{github.event.pull_request.number}}-${{github.event.pull_request.head.ref}}"
jobs:
  delete-review-app:
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: arn:aws:iam::842676007477:role/review-github-actions-forms-admin
          aws-region: eu-west-2
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Determine Terraform version
        id: terraform-version
        run: |
          TF_VERSION=$(< .review_apps/.terraform-version)
          printf "TF_VERSION=%s\n" "$TF_VERSION" >> "$GITHUB_OUTPUT"

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{steps.terraform-version.outputs.TF_VERSION}}

      - name: Delete review app
        run: |
          cd .review_apps/

          terraform init -backend-config="key=review-apps/forms-admin/pr-${{github.event.pull_request.number}}.tfstate"
          terraform destroy \
            -var "pull_request_number=${{github.event.pull_request.number}}" \
            -var "forms_admin_container_image=${{env.IMAGE_TAG}}" \
            -no-color \
            -auto-approve

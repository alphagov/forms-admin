name: "Terraform"
on:
  pull_request:
    branches: [main]
    paths:
      - ".review_apps/**"
  merge_group:
    types: [checks_requested]
jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Determine Terraform version
        id: terraform-version
        run: |
          TF_VERSION=$(< .review_apps/.terraform-version)
          printf "TF_VERSION=%s\n" "$TF_VERSION" >> "$GITHUB_OUTPUT"

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{steps.terraform-version.outputs.TF_VERSION}}

      - name: Check Terraform style
        id: tf_fmt
        working-directory: ".review_apps/"
        run: |
          terraform fmt -write=false -diff=true -list=true -recursive -check

      - name: Lint Terraform
        run: |
          pip install -r .review_apps/requirements.txt
          checkov -d .review_apps/ --framework terraform --quiet

      - name: Validate Terraform syntax
        working-directory: ".review_apps/"
        run: |
          terraform init -backend=false || exit
          terraform validate

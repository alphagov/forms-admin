name: "Review apps: on PR change"
on:
  pull_request:
    types: [opened, reopened, synchronize]

concurrency:
  group: "review-apps-forms-admin-pr-${{ github.event.pull_request.number }}"
  cancel-in-progress: false

jobs:
  update-review-app:
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: arn:aws:iam::842676007477:role/review-github-actions-forms-admin
          aws-region: eu-west-2

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Generate container image URI
        run: |
          echo "CONTAINER_IMAGE_URI=842676007477.dkr.ecr.eu-west-2.amazonaws.com/forms-admin:pr-${{github.event.pull_request.number}}-${{github.event.pull_request.head.sha}}-$(date +%s)" >> "$GITHUB_ENV"

      - name: Build container
        run: docker build --tag "${{env.CONTAINER_IMAGE_URI}}" .

      - name: Push container
        run: |
          aws ecr get-login-password --region eu-west-2 \
          | docker login --username AWS --password-stdin 842676007477.dkr.ecr.eu-west-2.amazonaws.com
          docker push "${CONTAINER_IMAGE_URI}"

      - name: Deploy review app via CodeBuild
        id: codebuild
        uses: aws-actions/aws-codebuild-run-build@4d15a47425739ac2296ba5e7eee3bdd4bfbdd767 # v1.0.18
        with:
          project-name: review-forms-admin-deploy
          env-vars-for-codebuild: |
            PR_NUMBER,
            CONTAINER_IMAGE
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CONTAINER_IMAGE: ${{ env.CONTAINER_IMAGE_URI }}

      - name: Fetch terraform outputs
        id: outputs
        run: |
          # Extract build UUID from ARN (format: arn:aws:codebuild:region:account:build/project:uuid)
          BUILD_ID="${{ steps.codebuild.outputs.aws-build-id }}"
          BUILD_UUID="${BUILD_ID##*:}"

          # Download artifact
          aws s3 cp "s3://forms-review-codebuild-artifacts/${BUILD_UUID}/review-forms-admin-deploy/outputs.json" outputs.json

          # Parse outputs
          {
            echo "REVIEW_APP_URL=$(jq -r '.review_app_url.value' outputs.json)"
            echo "ECS_CLUSTER_ID=$(jq -r '.review_app_ecs_cluster_id.value' outputs.json)"
            echo "ECS_SERVICE_NAME=$(jq -r '.review_app_ecs_service_name.value' outputs.json)"
          } >> "$GITHUB_OUTPUT"

          # Clean up artifact
          aws s3 rm "s3://forms-review-codebuild-artifacts/${BUILD_UUID}/review-forms-admin-deploy/outputs.json"

      - name: Wait for AWS ECS deployments to finish
        run: |
          aws ecs wait services-stable \
            --cluster "${{ steps.outputs.outputs.ECS_CLUSTER_ID }}" \
            --services "${{ steps.outputs.outputs.ECS_SERVICE_NAME }}"

      - name: Comment on PR
        env:
          COMMENT_MARKER: <!-- review apps on pr change -->
          GH_TOKEN: ${{ github.token }}
        run: |
          cat <<EOF > "${{runner.temp}}/pr-comment.md"
          :tada: A review copy of this PR has been deployed! You can reach it at: ${{steps.outputs.outputs.REVIEW_APP_URL}}

          It may take 5 minutes or so for the application to be fully deployed and working. If it still isn't ready
          after 5 minutes, there may be something wrong with the ECS task. You will need to go to the integration AWS account
          to debug, or otherwise ask an infrastructure person.

          For the sign in details and more information, [see the review apps wiki page](https://github.com/alphagov/forms-team/wiki/Review-apps).

          $COMMENT_MARKER
          EOF

          old_comment_ids=$(gh api "repos/{owner}/{repo}/issues/${{github.event.pull_request.number}}/comments" --jq "map(select((.user.login == \"github-actions[bot]\") and (.body | endswith(env.COMMENT_MARKER + \"\n\")))) | .[].id")
          for comment_id in $old_comment_ids; do
            gh api -X DELETE "repos/{owner}/{repo}/issues/comments/${comment_id}"
          done

          gh pr comment "${{github.event.pull_request.html_url}}" --body-file "${{runner.temp}}/pr-comment.md"
